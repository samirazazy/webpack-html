define(["marionette","components/option/option","jqueryUI"],function(e,t){var o=function(e){return this.members={DND_COMP_REF:e,dndType:void 0,bDropCopy:!1,bDragCopy:!1,bMultiAccept:!1,bAcceptCorrectOnly:!1,bRplaceExisting:!0,dndItemView:{},activeDroppable:void 0,activeDraggable:void 0,activeDraggableUI:void 0,revertToPosition:"flase",revertToOriginalPosition:"true",dndElements:{},itemHolder:void 0,arrDragList:void 0,arrDropList:void 0,itemCounterDrag:0,itemCounterDrop:0,itemCounter:0,zIndexValue:1,containment:void 0,click:{},removeItemRef:!1},_.extend(this,Backbone.Events)};return o.prototype.ONE_TO_ONE="oneToOne",o.prototype.ONE_TO_Many="oneToMany",o.prototype.DND_INITLIZED="dndInitlize",o.prototype.DRAGGABLE="draggable",o.prototype.DROPPABLE="droppable",o.prototype.DND_ITEM_DRAG_START_EVENT="dndItemDragStartEvent",o.prototype.DND_ITEM_DROP_EVENT="dndItemDropEvent",o.prototype.DND_ITEM_DRAG_STOP_EVENT="dndItemDragStopEvent",o.prototype.DND_ITEM_DRAG_MOVE_EVENT="dndItemDragMoveEvent",o.prototype.dndType=function(e){this.members.dndType=e},o.prototype.dropCopy=function(e){this.members.bDropCopy="true"===e||e===!0?!0:!1},o.prototype.dragCopy=function(e){this.members.bDragCopy="true"===e||e===!0?!0:!1},o.prototype.multiAccept=function(e){this.members.bMultiAccept="true"===e||e===!0?!0:!1},o.prototype.acceptCorrectOnly=function(e){this.members.bAcceptCorrectOnly="true"===e||e===!0?!0:!1},o.prototype.replaceExisting=function(e){this.members.bRplaceExisting="true"===e||e===!0?!0:!1},o.prototype.revertToPosition=function(e){this.members.revertToPosition="true"===e?!0:"false"===e?!1:e},o.prototype.revertToOriginalPosition=function(e){this.members.revertToOriginalPosition="true"===e?!0:"false"===e?!1:e},o.prototype.CreateDraggble=function(e,t){var o,r;for(r=this.members,r.arrDragList=e,o=0;o<r.arrDragList.length;o+=1)this.createElements(t,r.arrDragList[o],"draggable")},o.prototype.CreateDroppable=function(e,t){var o,r;for(r=this.members,r.arrDropList=e,o=0;o<r.arrDropList.length;o+=1)this.createElements(t,r.arrDropList[o],"droppable")},o.prototype.createElements=function(e,o,r){var i,a,n,s;void 0===this.members.itemHolder&&(this.members.itemHolder=e.find("#dndHolder")),i=r===this.DRAGGABLE?this.members.itemCounterDrag++:this.members.itemCounterDrop++,a=r+"_"+i,n=this.getElementModel(o,a),s=new t,s.model=n,this.members.itemCounter++,s.setName(a),s.render(),s.$el.attr("id",o.id),s.$el.attr("type",r),s.$el.attr("dataCID",s.cid),s.$el.attr("nCounter",i),this.members.itemHolder.append(s.$el),this.members.dndElements[s.cid]=s,r===this.DRAGGABLE&&this.addDragEvent(s.$el),r===this.DROPPABLE&&this.addDropEvent(s.$el),this.members.dndItemView[a]=s,s.$el.removeAttr("style"),s.$el.addClass(r+i),o.styleClass&&s.$el.addClass(o.styleClass),o.styleLeft&&s.$el.css("left",o.styleLeft),o.styleTop&&s.$el.css("top",o.styleTop)},o.prototype.getElementModel=function(e,t){var o,r;return o=this.members,new(r=Backbone.Model.extend({defaults:{parentCID:t,id:e.id,correctFor:e.correctFor,label:e.label,type:e.type,img:"",onlyCorrect:o.bAcceptCorrectOnly,multiAccept:o.bMultiAccept,replace:o.bRplaceExisting,filledWith:[],position:void 0,originalPosition:void 0}}))},o.prototype.addDropEvent=function(e){var t=this;e.droppable({drop:function(e,o){t.handleDropEvent(e,o)}})},o.prototype.addDragEvent=function(e){var t=this;$(e).draggable({revert:function(e){return t.handleDragRevert(e)},start:function(e,o){t.handleDragStart(e,o)},stop:function(e,o){t.handleDragStop(e,o)},drag:function(e,o){t.handleDragItemMovement(e,o)}}),(this.members.bDropCopy===!0||this.members.bDragCopy===!0)&&$(e).draggable({helper:"clone"})},o.prototype.initlizeDraggable=function(){this.trigger(this,this.DND_INITLIZED,this)},o.prototype.handleDragStart=function(e,t){var o,r,i,a,n,s,p;o=this,this.members.click.x=e.clientX,this.members.click.y=e.clientY,this.members.zIndexValue++,this.members.activeDraggable=e.currentTarget,this.members.activeDraggableUI=t,this.members.DND_COMP_REF.dispatchDnDEvent(this.DND_ITEM_DRAG_START_EVENT,this.getEventData()),$(this.members.activeDraggable).css("z-index",this.members.zIndexValue),(this.members.bDropCopy===!0||this.members.bDragCopy===!0)&&(this.members.zIndexValue++,t.helper.css("z-index",this.members.zIndexValue)),$(this.members.activeDraggable).draggable({stack:$(o.members.itemHolder)}),r=$(e.target).attr("datacid"),i=this.members.dndElements[r],void 0===i.model.get("position")&&(a={},p=t.originalPosition,n=p.left/this.members.DND_COMP_REF.getStageScaleValue(),s=p.top/this.members.DND_COMP_REF.getStageScaleValue(),a.left=n,a.top=s,i.model.set("position",a),i.model.set("originalPosition",a))},o.prototype.handleScaling=function(){},o.prototype.handleDragStop=function(){this.members;this.members.DND_COMP_REF.dispatchDnDEvent(this.DND_ITEM_DRAG_STOP_EVENT,this.getEventData())},o.prototype.handleDragItemMovement=function(e,t){var o,r,i,a,n,s,p;i=t.originalPosition,o=(e.clientX-this.members.click.x+i.left)/this.members.DND_COMP_REF.getStageScaleValue(),r=(e.clientY-this.members.click.y+i.top)/this.members.DND_COMP_REF.getStageScaleValue(),void 0!==this.containment&&(a=$(this.containment).position().left/this.members.DND_COMP_REF.getStageScaleValue(),n=$(this.containment).position().top/this.members.DND_COMP_REF.getStageScaleValue(),s=a+$(this.containment).width()-$(this.members.activeDraggable).width(),p=n+$(this.containment).height()-$(this.members.activeDraggable).height(),a>o?o=a:o>s&&(o=s),n>r?r=n:r>p&&(r=p)),t.position.left=o,t.position.top=r,this.members.DND_COMP_REF.dispatchDnDEvent(this.DND_ITEM_DRAG_MOVE_EVENT,this.getEventData())},o.prototype.handleDropEvent=function(e){this.members.activeDroppable=e.target},o.prototype.verifyDroppedItem=function(e,t){var o,r,i,a,n,s,p,l,d,m,g,c,D;return r=$(e).attr("dataCID"),i=$(t).attr("dataCID"),a=this.getItemModel(r),n=this.getItemModel(i),o=a.get("id"),s=n.get("correctFor"),l=n.get("onlyCorrect"),d=n.get("multiAccept"),m=n.get("replace"),p=s.split(","),g=-1!==p.indexOf(o)?!0:!1,c=n.get("filledWith").length>0?!0:!1,D=-1!==n.get("filledWith").indexOf(r)?!0:!1,!c||d||D||m?l&&!g?!1:!0:!1},o.prototype.getItemModel=function(e){var t,o;return o=this.members.dndElements[e],void 0!==o&&(t=o.model),t},o.prototype.addDraggableCopy=function(){var e,o,r,i,a;e=this.members,r=$(e.activeDraggable).attr("dataCID"),i=this.getItemModel(r),o={},o.nCounter=$(e.activeDraggable).attr("nCounter"),o.type=i.get("type"),o.id=i.get("id"),o.label=i.get("label"),o.img=i.get("img"),o.position=i.get("position"),o.originalPosition=i.get("originalPosition"),i=this.getElementModel(o),i.set("position",o.position),i.set("originalPosition",o.originalPosition),o.objOption=new t,o.objOption.model=i,o.objOption.render(),o.objOption.$el.attr("dataCID",o.objOption.cid),o.objOption.$el.attr("nCounter",o.nCounter),o.objOption.$el.removeAttr("style"),o.objOption.$el.addClass(o.type+o.nCounter),e.bDropCopy=!1,e.bDragCopy===!0&&(a=e.bDragCopy,e.bDragCopy=!1),this.addDragEvent(o.objOption.$el),e.bDropCopy=!0,void 0!==a&&(e.bDragCopy=a,a=void 0),e.itemHolder.append(o.objOption.$el),e.dndElements[o.objOption.cid]=o.objOption,e.activeDraggable=o.objOption.$el},o.prototype.handleDragRevert=function(){var e,t,o,r,i,a,n,s;return t=this.members,o=$(t.activeDraggable).attr("dataCID"),i=this.getItemModel(o),void 0!==t.activeDroppable?(e=this.verifyDroppedItem(t.activeDraggable,t.activeDroppable))?(t.bDropCopy===!0&&void 0===$(t.activeDraggable).attr("droppedAt")&&this.addDraggableCopy(),o=$(t.activeDraggable).attr("dataCID"),void 0!==$(t.activeDraggable).attr("droppedAt")&&(r=$(t.activeDraggable).attr("droppedAt"),$(t.activeDraggable).removeAttr("droppedAt"),a=this.getItemModel(r),s=a.get("filledWith"),s.splice(s.indexOf(o),1)),r=$(t.activeDroppable).attr("dataCID"),$(t.activeDraggable).attr("droppedAt",r),a=this.getItemModel(r),s=a.get("filledWith"),s.length>0&&a.get("multiAccept")===!1&&a.get("replace")===!0&&this.resetItem(t.activeDroppable),s.push(o),this.setElementInCenter(t.activeDraggable,t.activeDroppable),this.members.DND_COMP_REF.dispatchDnDEvent(this.DND_ITEM_DROP_EVENT,this.getEventData()),t.activeDraggable=t.activeDroppable=void 0,!1):(this.members.DND_COMP_REF.dispatchDnDEvent(this.DND_ITEM_DROP_EVENT,this.getEventData()),o=$(t.activeDraggable).attr("dataCID"),t.activeDraggableUI.originalPosition.left=i.get("position").left,t.activeDraggableUI.originalPosition.top=i.get("position").top,void 0!==$(t.activeDraggable).attr("droppedAt")&&t.revertToOriginalPosition&&(r=$(t.activeDraggable).attr("droppedAt"),$(t.activeDraggable).removeAttr("droppedAt"),a=this.getItemModel(r),s=a.get("filledWith"),s.splice(s.indexOf(o),1),t.bDropCopy===!0?(n={},n.objOption=t.dndElements[o],$(n.objOption.$el).draggable("destroy"),$(n.objOption.$el).remove(),delete t.dndElements[o]):t.bDragCopy===!0&&(t.activeDraggableUI.helper.remove(),this.resetItem(t.activeDraggable))),t.activeDraggable=t.activeDroppable=void 0,t.revertToPosition):void 0===t.activeDroppable?(t.activeDraggableUI.originalPosition.left=i.get("originalPosition").left,t.activeDraggableUI.originalPosition.top=i.get("originalPosition").top,i.set("position",i.get("originalPosition")),void 0!==$(t.activeDraggable).attr("droppedAt")&&(r=$(t.activeDraggable).attr("droppedAt"),$(t.activeDraggable).removeAttr("droppedAt"),a=this.getItemModel(r),s=a.get("filledWith"),s.splice(s.indexOf(o),1),t.bDropCopy===!0?(n={},n.objOption=t.dndElements[o],$(n.objOption.$el).draggable("destroy"),$(n.objOption.$el).remove(),delete t.dndElements[o]):t.bDragCopy===!0&&(t.activeDraggableUI.helper.remove(),this.resetItem(t.activeDraggable))),this.members.DND_COMP_REF.dispatchDnDEvent(this.DND_ITEM_DROP_EVENT,this.getEventData()),t.activeDraggable=t.activeDroppable=t.activeDraggableUI=void 0,t.revertToPosition):void 0},o.prototype.setElementInCenter=function(e,t){var o,r,i,a;e=$(e),t=$(t),o=parseFloat(t.css("left"))+(t.innerWidth()-e.innerWidth())/2,r=parseFloat(t.css("top"))+(t.innerHeight()-e.innerHeight())/2,e.css("position","absolute"),e.css("left",o+"px"),e.css("top",r+"px"),e.css("z-index",this.members.zIndexValue),this.members.revertToOriginalPosition||(a=$(e).attr("datacid"),i=this.members.dndElements[a],i.model.set("position",{left:o,top:r}))},o.prototype.freezOption=function(e){$(e).draggable("disable")},o.prototype.unfreezOption=function(e){$(e).draggable("enable")},o.prototype.removeDragFeatureFromOption=function(e){$(e).draggable("destroy")},o.prototype.setContainment=function(e){this.containment=void 0!==e&&$(e).length>0?e:void 0},o.prototype.getContainment=function(){return this.containment},o.prototype.getEventData=function(){var e,t,o,r,i,a,n={};return e=this.members,n.isCorrect=!1,void 0!==e.activeDraggable&&(n.left=$(e.activeDraggableUI.helper).position().left,n.top=$(e.activeDraggableUI.helper).position().top,void 0!==e.activeDroppable&&(t=$(e.activeDraggable).attr("dataCID"),i=this.getItemModel(t),o=i.get("id"),r=$(e.activeDroppable).attr("dataCID"),a=this.getItemModel(r),-1!==a.get("correctFor").indexOf(o)&&(n.isCorrect=!0))),n.dragItem=e.activeDraggable,n.dropItem=e.activeDroppable,n},o.prototype.resetDraggable=function(e){var t,o,r,i,a,n,s,p;t=this.members,a=this.getItemModel(e),o=a.get("id"),r=t.dndElements[e],void 0!==$(r.$el).attr("droppedAt")&&(i=$(r.$el).attr("droppedAt"),n=this.getItemModel(i),$(r.$el).removeAttr("droppedAt"),s=n.get("filledWith"),s.splice(s.indexOf(e),1),t.bDropCopy===!0&&(p={},p.objOption=t.dndElements[e],$(p.objOption.$el).draggable("destroy"),$(p.objOption.$el).remove(),t.dndElements[e]=void 0)),$(r.$el).removeAttr("style")},o.prototype.showAnswer=function(){var e,t,o,r,i,a,n=this,s=[],p=[];return $.each(this.members.dndElements,function(){e=void 0,e=this.$el.attr("dataCID"),o=n.getItemModel(e),i=o.get("type"),i===n.DRAGGABLE&&(t=void 0,a=void 0,void 0!==this.$el.attr("droppedAt")&&(t=this.$el.attr("droppedAt"),r=n.getItemModel(t),a=r.get("correctFor"),-1!==a.indexOf(o.get("id"))?s.push(o.get("id")):p.push(o.get("id"))))}),{correct:s,incorrect:p}},o.prototype.resetDroppable=function(e){var t,o,r,i;for(t=this.members,o=this.getItemModel(e),r=o.get("filledWith"),i=r.length;i>0;)this.resetDraggable(r[0]),i-=1},o.prototype.resetItem=function(e){var t,o,r;t=$(e).attr("dataCID"),o=this.getItemModel(t),r=o.get("type"),r===this.DRAGGABLE?this.resetDraggable(t):this.resetDroppable(t)},o.prototype.resetAll=function(){var e=this;$.each(this.members.dndElements,function(){this instanceof t&&e.resetItem(this.$el)})},o.prototype.getElementByCid=function(e){var t,o;return t=this.members.dndElements[e],o=t.$el},o.prototype.changeCorrectFor=function(e,t){var o,r,i;if(o=this.members.itemHolder.find("#"+e)[0],"droppable"!==$(o).attr("type"))throw new Error("Data can only be set on droppables!!");r=$(o).attr("dataCID"),i=this.getItemModel(r),i.set("correctFor",t)},o.prototype.destroy=function(){var e=this;$.each(this.members.dndElements,function(){if(this instanceof t){e.resetItem(this.$el);try{this.model.get("type")===this.DRAGGABLE?$(this.$el).draggable("destroy"):$(this.$el).droppable("destroy")}catch(o){}this.model.set("filledWith",[]),this.model.set("position",void 0),this.model=null,$(this.$el).remove()}}),this.members.dndElements={},this.members.itemCounterDrag=0,this.members.itemCounterDrop=0,this.members.itemCounter=0,this.members.zIndexValue=1,this.members.DND_COMP_REF=void 0,delete this.members},o});