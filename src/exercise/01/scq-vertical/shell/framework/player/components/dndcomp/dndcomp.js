define(["marionette","components/container","components/dndcomp/model","components/draggable/draggable","components/droppable/droppable"],function(e,t,o,s,i){var l,n=t.extend({objData:null,template:_.template(""),objDraggable:void 0,objCase:[],objFeedback:null,count:0,objLives:null,objHint:null,objImage:null,objLabel:null,objClone:null,initialize:function(e){this.objData=e,this.model=new o(e),l=this,this.componentType="dnd"},onShow:function(){this.preInitScreenElement(),this.customEventDispatcher(this.eventConst.CREATION_COMPLETE,this,this)}});return n.prototype.ATTEMPT_OVER_EVENT="attemptOverEvent",n.prototype.preInitScreenElement=function(){this.$el.addClass(this.styleClass())},n.prototype.addChild=function(e){var t,o,l,n=e.component;if(n instanceof s)this.storeChilds(n,"draggables")&&(this.addDraggableEvents(n),("true"===this.model.get("cloning")||this.model.get("cloning")===!0)&&n.enableCloning(),this.model.get("gridX")>0&&(o=this.model.get("gridX")),this.model.get("gridY")>0&&(l=this.model.get("gridY")),n.setGrid(o,l),t="draggables");else if(n instanceof i)this.storeChilds(n,"droppables")&&this.addDroppableEvents(n);else if("hint"===n.componentType)this.objHint=n;else if("lives"===n.componentType)this.objLives=n;else if("feedback"===n.componentType)this.objFeedback=n;else if("image"===n.componentType)this.objImage=n;else if("label"===n.componentType)this.objLabel=n;else if("case"===n.componentType)this.objCase.push(n);else if(!this.bEditor)return console.warn("DndComp can only have Draggable or Droppable kind of objects!!"),void 0;this.DnDSuper.prototype.addChild.call(this,e),this.bEditor||this.randomizePositions(t)},n.prototype.isValid=function(e){var t=!1;return t="draggable"===e||"droppable"===e||"image"===e||"case"===e||"feedback"===e||"hint"===e||"lives"===e||"life"===e||"label"===e?!0:!1},n.prototype.storeChilds=function(e,t){var o,s,i;return i=this.model.get(t),o=i.length>0?i.split("|"):[],s=o.indexOf(e.getID()),0>s?(o.push(e.getID()),this.model.set(t,o.join("|")),!0):!1},n.prototype.randomizePositions=function(e){var t,o,s,i,l;void 0!==e&&(o=this.model.get(e).split("|"),t=Math.floor(Math.random()*o.length),s=this[o[t]],t=Math.floor(Math.random()*o.length),i=this[o[t]],s.getID()!==i.getID()&&"true"===this.model.get("shuffle")&&(l=s.styleClass(),s.styleClass(i.styleClass()),i.styleClass(l)))},n.prototype.addDraggableEvents=function(e){e.on("start",this.onDragStart),e.on("drag",this.onDragMove),e.on("stop",this.onDragStop)},n.prototype.addDroppableEvents=function(e){e.on("drop",this.onDrop),e.on("over",this.onOver)},n.prototype.onDragStart=function(e){var t,o=l.model.get("lastzindex")+1;l.model.set("lastzindex",o),this.setZindex(o),this.setContainmentDiv(l.$el),l.objDraggable=this,("true"===l.objDraggable.model.get("clone")||l.objDraggable.model.get("clone")===!0)&&($(e.customData.ui.helper).css("z-index",o),t=l.objDraggable.originalPos,l.objClone=l.getClone(l.objDraggable),l.objClone.setOriginalPosition(t),l.objClone.$el.hide(),l.objClone.on("revertComplete",function(){l.removeClone(this),l.objClone=null}),l.objDraggable=l.objClone),l.customEventDispatcher("onDragStart",l,this)},n.prototype.removeClone=function(e){delete l[e.getID()],e.$el.remove(),e.destroy(),l.updateModel()},n.prototype.updateModel=function(){var e,t;e=l.model.get("draggables").split("|"),t=l.model.get("draggables").split("|"),$.each(e,function(e,o){void 0===l[o]&&t.splice(t.indexOf(o),1)}),l.model.set("draggables",t.join("|"))},n.prototype.onDragMove=function(){l.customEventDispatcher("onDragMove",l,this)},n.prototype.onDragStop=function(e){l.objDraggable&&(null!==l.objClone&&(l.objDraggable.setCurrentPosition(e.customData.ui.position),l.objDraggable.$el.show()),l.removeAssociation(l.objDraggable.getID()),l.objDraggable.revertBack()),l.objDraggable=void 0,l.objClone=null,l.customEventDispatcher("onDragStop",l,this)},n.prototype.onOver=function(){l.customEventDispatcher("onOver",l,this)},n.prototype.onDrop=function(e){if(void 0!==l.objDraggable){if(l.objDraggable&&l.objDraggable.model.get("droppedAt")===this.getID())return l.objDraggable=void 0,l.arrange(this),void 0;l.removeAssociation(l.objDraggable.getID()),l.validateOnDrop(this)&&(null!==l.objClone&&(l.objClone.setCurrentPosition(e.customData.ui.position),l.objClone.$el.show(),l.objClone=null),l.makeAssociation(l.objDraggable.getID(),this.getID()),l.objDraggable=void 0),l.customEventDispatcher("onDrop",l,this),l.getStatus().bAllDropped?l.customEventDispatcher("onAllPlaced",l,this):l.customEventDispatcher("onAllNotPlaced",l,this)}},n.prototype.validateOnDrop=function(e){var t,o,s,i;if(o=l.model.get("type"),t=l.model.get("ondropreplace"),"ONE_TO_ONE"===o){if(e.isEmpty())return!0;if("true"===t||t===!0)return s=e.model.get("filledWith"),l.removeAssociation(s),i=l[s],i.revertBack(),!0}else if("MANY_TO_ONE"===o)return!0;return!1},n.prototype.attempt=function(){var e=!1;this.objLives&&(this.model.set("attempts",this.objLives.getTotalLivesCount()),this.objLives.loselife()),-1===this.count&&void 0===this.count||(++this.count,this.count===parseInt(this.model.get("attempts"),10)&&(e=!0,this.customEventDispatcher(this.ATTEMPT_OVER_EVENT,this,this)))},n.prototype.attemptsCount=function(){return this.count},n.prototype.showLives=function(){null!==this.objLives&&this.objLives.showLives()},n.prototype.hideLives=function(){null!==this.objLives&&this.objLives.hideLives()},n.prototype.arrange=function(e){var t,o,s,e,i,l=0,n=0;if(e)switch(this.model.get("ondropalignment")){case"VERTICAL":if(l=parseFloat(e.$el.css("left")),n=parseFloat(e.$el.css("top")),o=e.model.get("filledWith"),o.length)for(s=o.split("|"),t=0;t<s.length;t+=1)i=this[s[t]],i.$el.css("top",n+"px"),i.$el.css("left",l+"px"),n+=i.$el.height(),n+i.$el.height()>parseFloat(e.$el.css("top"))+e.$el.height()&&(n=parseFloat(e.$el.css("top")),l+=i.$el.width()),"auto"===i.$el.css("z-index")&&i.$el.css("z-index",1);break;case"HORIZONTAL":if(l=parseFloat(e.$el.css("left")),n=parseFloat(e.$el.css("top")),o=e.model.get("filledWith"),o.length)for(s=o.split("|"),t=0;t<s.length;t+=1)i=this[s[t]],i.$el.css("top",n+"px"),i.$el.css("left",l+"px"),l+=i.$el.width(),l+i.$el.width()>parseFloat(e.$el.css("left"))+e.$el.width()&&(l=parseFloat(e.$el.css("left")),n+=i.$el.height()),"auto"===i.$el.css("z-index")&&i.$el.css("z-index",1);break;case"CENTER":if(l=parseFloat(e.$el.css("left")),n=parseFloat(e.$el.css("top")),o=e.model.get("filledWith"),o.length)for(s=o.split("|"),t=0;t<s.length;t+=1)i=this[s[t]],l=parseFloat(e.$el.css("left"))+(e.$el.width()-i.$el.width())/2,n=parseFloat(e.$el.css("top"))+(e.$el.height()-i.$el.height())/2,i.$el.css("top",n+"px"),i.$el.css("left",l+"px"),"auto"===i.$el.css("z-index")&&i.$el.css("z-index",1)}},n.prototype.removeAssociation=function(e){var t,o,s,i;t=this[e].model,void 0!==t.get("droppedAt")&&(s=this[t.get("droppedAt")],t.set("droppedAt",void 0)),s&&(t=s.model,o=t.get("filledWith").split("|")),o&&(i=o.indexOf(e)),i>-1&&(o.splice(i,1),t.set("filledWith",o.join("|"))),this.arrange(s)},n.prototype.makeAssociation=function(e,t){var o,s;o=this[e].model,o.set("droppedAt",t),o=this[t].model,this[t].isEmpty()||(s=o.get("filledWith").split("|"),s.push(e),e=s.join("|")),o.set("filledWith",e),this.arrange(this[t])},n.prototype.getState=function(){var e,t,o,s,i,l,n,a,r,h,d=this;for(t=[],h={},i=this.model.get("droppables"),i.length>0&&(t=i.split("|")),e=0;e<t.length;e++)l=t[e],h[l]=d[l].model.get("filledWith"),d[l].feedback&&(h[d[l].feedback.strCompId]=d[l].feedback.getState());for(n=this.model.get("draggables"),n.length>0&&(r=n.split("|")),e=0;e<r.length;e++)a=r[e],d[a].feedback&&"false"===d[a].model.get("clone")?h[d[a].feedback.strCompId]=d[a].feedback.getState():-1!==a.indexOf("_clone_")&&(o=d[a].$el.children(),s=o.children(),h[d[a].strCompId]="inline"===s[0].style.display?!0:!1);return d.objFeedback&&(h[d.objFeedback.strCompId]=d.objFeedback.getState()),h},n.prototype.setState=function(e){var t,o,s,i,l,n,a,r,h,d,p=this;for(p.reset("ALL",!1),$.each(e,function(e,n){if(-1!==e.indexOf("droppable_")){for(l=[],n&&n.length&&(l=n.split("|")),t=0;t<l.length;t+=1)o=l[t],-1!==o.indexOf("_clone_")?(s=p[o.split("_clone_")[0]],(s.model.get("clone")===!0||"true"===s.model.get("clone"))&&(p[o]?i=p[o]:(i=p.getClone(s,o),i.setOriginalPosition(s.$el.position()),i.model.set("droppedAt",e),s.model.set("cloneCounter",s.model.get("cloneCounter")+1),i.off("revertComplete").on("revertComplete",function(){p.removeClone(this),p.objClone=null})))):(s=p[o],s.model.set("droppedAt",e));p[e].model.set("filledWith",n),p.arrange(p[e])}}),h=this.model.get("droppables").split("|"),t=0;t<h.length;t+=1)r=h[t],p[r].feedback&&p[r].feedback.setState(e[p[r].feedback.strCompId]);for(n=this.model.get("draggables").split("|"),t=0;t<n.length;t+=1)o=n[t],p[o].feedback&&"false"===p[o].model.get("clone")?p[o].feedback.setState(e[p[o].feedback.strCompId]):-1!==o.indexOf("_clone_")&&(a=p[o].$el.children(),d=a.children(),e[p[o].strCompId]===!0?(a.show(),d[0].style.display="inline",d[1].style.visibility="hidden"):(a.show(),d[0].style.visibility="hidden",d[1].style.display="inline"));p.objFeedback&&p.objFeedback.setState(e[p.objFeedback.strCompId])},n.prototype.showAnswer=function(){var e,t,o,s,i,n,a,r,h,d,p,g;for(o=[],s=[],g={},l.reset("ALL",!1),n=this.model.get("droppables"),n.length>0&&(o=n.split("|")),n=this.model.get("draggables"),n.length>0&&(s=n.split("|")),e=0;e<o.length;e+=1){for(h=o[e],d=l[h],a=d.getValue(),-1!==a.indexOf("|")?r=a.split("|"):(r=[],r.push(a)),i="",t=0;t<s.length;t+=1)s[t]&&(p=l[s[t]],n=p.getValue(),p.originalPosition||p.setOriginalPosition(p.$el.position()),-1!==r.indexOf(n)&&(p.model.get("clone")===!0||"true"===p.model.get("clone")?(p.getClone(),i+=s[t]+"_clone_"+p.model.get("cloneCounter")):(i+=s[t],s[t]=void 0),r.length>1&&(i+="|"),r.splice(r.indexOf(n),1)));g[h]=i}this.sendStatementToLRS("showAnswer_",""),l.setState(g)},n.prototype.checkAnswer=function(){this.attempt();var e=!1,t=this._checkAnswer();t.INCORRECT.length>0?(this.customEventDispatcher("allNotCorrect",l,t),e=!1,this.sendStatementToLRS("checkAnswer_",!1)):t.CORRECT.length===t.TOTAL?(this.customEventDispatcher("allCorrect",l,t),this.sendStatementToLRS("checkAnswer_",!0),e=!0):(e=!1,this.customEventDispatcher("allNotCorrect",l,t),this.sendStatementToLRS("checkAnswer_",!1)),this.customEventDispatcher("onCheckAnswer",this,e),this.showFeedback()},n.prototype._checkAnswer=function(){var e,t,o,s,i,n,a,r,h,d,p,g=0;for(o=this.model.get("droppables"),i=[],h=[],d=[],o.length>0&&(i=o.split("|")),e=0;e<i.length;e+=1)for(a=l[i[e]],o=a.model.get("filledWith"),s=a.getValue(),-1!==s.indexOf("|")?g+=s.split("|").length:s.trim().length&&(g+=1),n=[],o.length>0&&(n=o.split("|")),t=0;t<n.length;t+=1)r=l[n[t]],-1===s.indexOf(r.getValue())?d.push(r.getID()):(h.push(r.getID()),s=s.replace(r.getValue(),""));return p={CORRECT:h,INCORRECT:d,TOTAL:g}},n.prototype.showFeedback=function(){var e=this.getStatus(),t=!0;t=e.arrIncorrect.length>0?!1:e.arrCorrect.length===e.total?!0:!1,this.objFeedback&&this.objFeedback.showFeedback(t),this.showDraggablesFeedback(),this.showDroppablesFeedback()},n.prototype.showDraggablesFeedback=function(){var e,t=this.getStatus(),o=[],s=this;e=this.model.get("draggables"),e.length&&(o=e.split("|")),$.each(o,function(e,o){-1!==t.arrCorrect.indexOf(o)?(-1!==o.indexOf("_clone_")&&s.showClonedDraggablesFeedback(o,!0),s[o].showFeedback(!0)):"false"===s[o].model.get("clone")?s[o].showFeedback(!1):-1!==o.indexOf("_clone_")&&s.showClonedDraggablesFeedback(o,!1)})},n.prototype.showClonedDraggablesFeedback=function(e,t){var o,s;o=this[e].$el.children(),s=o.children(),o.show(),"true"===t||t===!0?(s[0].style.display="inline",s[1].style.display="none"):(s[0].style.display="none",s[1].style.display="inline")},n.prototype.showDroppablesFeedback=function(){var e,t,o,s,i,n,a,r,h,d;for(o=this.model.get("droppables"),o.length>0&&(s=o.split("|")),e=0;e<s.length;e+=1){var p=[];for(i=l[s[e]],n=i.getValue().split("|"),a=i.model.get("filledWith"),r=a.split("|"),t=0;t<r.length;t+=1)h=r[t],h&&(d=this[h].getValue(),p.push(d));p.toString()===n.toString()?i.showFeedback(!0):i.showFeedback(!1)}},n.prototype.hideFeedback=function(){this.objFeedback&&this.objFeedback.hideFeedback(),this.hideDraggablesFeedback(),this.hideDroppablesFeedback()},n.prototype.hideDraggablesFeedback=function(){var e,t=[],o=this;e=this.model.get("draggables"),e.length&&(t=e.split("|")),$.each(t,function(e,t){o[t].hideFeedback()})},n.prototype.hideDroppablesFeedback=function(e){var t;this[e]&&(t=this[e],t.feedback&&t.feedback.hide())},n.prototype.showHint=function(){null!==this.objHint&&this.objHint.showHint(),this.showDraggablesHint(),this.showDroppablesHint()},n.prototype.showDraggablesHint=function(){this._showHideDragDropHint("draggables",!0)},n.prototype.showDroppablesHint=function(){this._showHideDragDropHint("droppables",!0)},n.prototype.hideHint=function(){null!==this.objHint&&this.objHint.hideHint(),this.hideDraggablesHint(),this.hideDroppablesHint()},n.prototype.hideDraggablesHint=function(){this._showHideDragDropHint("draggables",!1)},n.prototype.hideDroppablesHint=function(){this._showHideDragDropHint("droppables",!1)},n.prototype._showHideDragDropHint=function(e,t){var o,s=[],i=this;o=this.model.get(e),o.length&&(s=o.split("|")),$.each(s,function(e,o){t?i[o].showHint():i[o].hideHint()})},n.prototype.resetDraggable=function(e,t){var o;this[e]&&(o=this[e],this.removeAssociation(e),o.revertBack(t))},n.prototype.reset=function(e,t){var o,s,i,l,n,a,r,h=this;for(l=this.getStatus(),a=this.model.get("droppables"),a.length&&(r=a.split("|")),"INCORRECT"===e?s=l.arrIncorrect:"CORRECT"===e?s=l.arrCorrect:("ALL"===e||void 0===e)&&(s=[],i=this.model.get("draggables"),i.length&&(s=i.split("|"))),$.each(s,function(e,o){h.resetDraggable(o,t)}),$.each(r,function(e,t){h.hideDroppablesFeedback(t)}),n=this.model.get("attempts"),this.count=0,o=0;n>o;o++)this.objLives&&this.objLives.gainlife();this.hideFeedback(),this.enable()},n.prototype.clear=function(e,t){var o,s,i,l,n=this;i=this.model.get("droppables"),i.length&&(l=i.split("|")),o=[],s=this.model.get("draggables"),s.length&&(o=s.split("|")),$.each(o,function(e,o){n.resetDraggable(o,t),n.hideDraggablesFeedback(o)}),$.each(l,function(e,t){n.hideDroppablesFeedback(t)}),this.hideFeedback(),this.enable()},n.prototype.resetIncorrect=function(){this.reset("INCORRECT")},n.prototype.resetCorrect=function(){this.reset("CORRECT")},n.prototype.getStatus=function(){var e,t,o,s,i,l,n,a,r,h;for(l=0,h={},s=!1,n=!1,t=[],a=[],o=this._checkAnswer(),i=this.model.get("draggables"),i.length>0&&(t=i.split("|"),o.CORRECT.length===o.TOTAL&&0===o.INCORRECT.length&&(n=!0)),e=0;e<t.length;e+=1)r=this[t[e]].model.get("droppedAt"),r&&(a.push({draggable:t[e],droppable:r}),l+=1);return l>=o.TOTAL&&(s=!0),h.arrDraggables=this.model.get("draggables").split("|"),h.arrDroppables=this.model.get("droppables").split("|"),h.bAllDropped=s,h.bAllCorrect=n,h.arrAssociations=a,h.arrCorrect=o.CORRECT,h.arrIncorrect=o.INCORRECT,h.total=o.TOTAL,h},n.prototype.enable=function(){var e,t,o;t=this.model.get("draggables").split("|"),o=this.model.get("droppables").split("|"),e=this,$.each(t,function(t,o){e[o].enable()}),$.each(o,function(t,o){e[o].enable()})},n.prototype.disable=function(){var e,t,o;t=this.model.get("draggables").split("|"),o=this.model.get("droppables").split("|"),e=this,$.each(t,function(t,o){e[o].disable()}),$.each(o,function(t,o){e[o].disable()})},n.prototype.data=function(e){return e?(this.model.set("data",e),void 0):this.model.get("data")},n.prototype.styleClass=function(e){return e?(this.model.set("styleClass",e),void 0):this.model.get("styleClass")},n.prototype.getClone=function(e,t){var o,i,l,n;return l=e.getClone(),o=t?t:e.getID()+"_clone_"+e.model.get("cloneCounter"),l.attr("id",o),this.$el.append(l),n=_.extend({},e.model.attributes),n=_.extend(n,{clone:!1,elementId:"#"+o}),i=new s(n),i.render(),i.setContainmentDiv(this.el),i.setID(o),this[o]=i,this.storeChilds(i,"draggables"),this.addDraggableEvents(i),i},n.prototype.setGrid=function(e,t){var o,s,i,l;if(l=this.model.get("draggables"),l.length>0)for(i=l.split("|"),o=0;o<i.length;o+=1)s=this[i[o]],s.setGrid(e,t)},n.prototype.DnDSuper=t,n.prototype.destroy=function(){var e,t,o,s,i,l;if(l=this.model.get("droppables"),l.length>0)for(s=l.split("|"),e=0;e<s.length;e+=1)o=this[s[e]],o.off("drop"),o.off("over");if(l=this.model.get("draggables"),l.length>0)for(i=l.split("|"),e=0;e<i.length;e+=1)t=this[i[e]],t.off("start"),t.off("drag"),t.off("stop");return this.DnDSuper.prototype.destroy.call(this,!0)},n});