define(["marionette","player/screen/screen-helper","components/case/case"],function(t,e,i){var s;return s=i.extend({objData:null,objMatchingChild:null,clickCounter:0,newCanvas:null,child_dict:null,answer_dict:{},feedback:null,colAObject:void 0,colBObject:void 0,lineVar:!1,hintComp:null,get_state_obj:null,scaleValue:1,arrCanvasLine:[],objTimer:null,lineColor:null,nTotalCount:0,flagSet:!1,template:_.template(""),initialize:function(t){this.componentType="matching",this.scaleValue=.8,this.arrCanvasLine=[],this.answer_dict={},this.child_dict={},this.get_state_obj={},this.objData=t,this.newCanvas=null},onShow:function(){this.preInitScreenElement(),this.customEventDispatcher(this.eventConst.CREATION_COMPLETE,this,this)},onPlayerResizeEvent:function(){this.newCanvas.attr("width",this.$el.outerWidth()).attr("height",this.$el.outerHeight())},isValid:function(t){var e=!1;return e="matchingChild"===t||"case"===t||"feedback"===t||"label"===t||"hint"===t},addChild:function(t){var e,i,s=this;switch(e=t.component,i=t.component.componentType){case"matchingChild":this.child_dict[e.getID()]=e,this.objMatchingChild=e,e.$el.on("click",s,this.handleChildClick),e.on("stateChanged",s,s.stateChanged),this.nTotalCount=this.nTotalCount+1;break;case"feedback":this.feedback=e;break;case"hint":this.hintComp=e}this.MatchingBoxSuper.prototype.addChild.call(this,t),this.bEditor===!1&&(this.$el.append(this.newCanvas),this.newCanvas.attr("id",this.getID()+"_canvas"))},handleChildClick:function(t){t.data.onOptionClicked(t)}}),s.prototype.DISABLED_STATE="disableState",s.prototype.ENABLED_STATE="enableState",s.prototype.GET_STATE_EVENT="getStateEvent",s.prototype.SET_STATE_EVENT="setStateEvent",s.prototype.RESET_STATE_EVENT="resetStateEvent",s.prototype.CHECK_ANSWER="checkAnswerEvent",s.prototype.SHOW_ANSWER="showAnswerEvent",s.prototype.CHILD_UPDATE_COMPLETE="onChildUpateCompleteEvent",s.prototype.PAIR_EVENT="onPairEvent",s.prototype.ALL_CHILD_PAIRED_EVENT="onAllChildPairedEvent",s.prototype.ALL_CHILD_NOT_PAIRED_EVENT="onAllChildNotPairedEvent",s.prototype.ON_ASSESSMENT_READY="onAssessmentReady",s.prototype.ON_ASSESSMENT_NOT_READY="onAssessmentNotReady",s.prototype.preInitScreenElement=function(){void 0!==this.objData.styleClass&&$(this.$el).addClass(this.objData.styleClass),this.newCanvas=$("<canvas/>").css({border:"1px solid transparent",position:"absolute",top:"0px",left:"0px","pointer-events":"none"})},s.prototype.removeChildById=function(t){delete this.child_dict[t],this.MatchingBoxSuper.prototype.removeChild.call(this,t),this.nTotalCount=this.nTotalCount-1},s.prototype.onOptionClicked=function(t){var e=t.currentTarget.id,i={},s=0;this.prepareDataForLines(e),i.allChild=this.child_dict,i.paired=this.answer_dict,_.filter(this.answer_dict,function(){s+=1}),s===this.nTotalCount?this.customEventDispatcher(this.ALL_CHILD_PAIRED_EVENT,this,this):this.customEventDispatcher(this.ALL_CHILD_NOT_PAIRED_EVENT,this,this),this.customEventDispatcher("stateChanged",this,t),this.isReady(i),this.tempVar=s},s.prototype.isReady=function(t){var e=0;_.filter(t.paired,function(){e+=1}),e===this.nTotalCount?this.customEventDispatcher(this.ON_ASSESSMENT_READY,this,this):this.customEventDispatcher(this.ON_ASSESSMENT_NOT_READY,this,this)},s.prototype.removeReferences=function(t){var e,i;void 0!==this.answer_dict[t]&&(e=this.answer_dict[t].split("_##_"),$(this.child_dict[e[0]].$el.children()[0]).removeClass(this.objData.pairedStyle).removeClass(this.objData.selectedStyle),$(this.child_dict[e[1]].$el.children()[0]).removeClass(this.objData.pairedStyle).removeClass(this.objData.selectedStyle),delete this.answer_dict[e[0]],void 0!==this.answer_dict[e[1]]&&(i=this.answer_dict[e[1]].split("_##_"),delete this.answer_dict[i[0]],delete this.answer_dict[i[1]]),delete this.answer_dict[e[1]])},s.prototype.prepareDataForLines=function(t,e){var i,s,o,a,h,n;this.colAObject&&$(this.colAObject.$el.children()[0]).removeClass(this.objData.selectedStyle),this.colBObject&&$(this.colBObject.$el.children()[0]).removeClass(this.objData.selectedStyle),"question"===this.child_dict[t].options.category?(this.colAObject=this.child_dict[t],$(this.colAObject.$el.children()[0]).addClass(this.objData.selectedStyle)):(this.colBObject=this.child_dict[t],$(this.colBObject.$el.children()[0]).addClass(this.objData.selectedStyle)),this.lineVar=this.removeLines(this.colAObject,this.colBObject),this.lineVar&&(n=$("canvas",this.$el),i=n.attr("id"),s=$("#"+i,this.$el)[0],o=s.getContext("2d"),o.scale(1,1),o.clearRect(0,0,$(this.$el).width(),$(this.$el).height())),this.bEditor===!1&&(this.lineColor=this.objData.lineColor,e===!0&&void 0!==this.objData.showAnswerColor?(this.lineColor=this.objData.showAnswerColor,a=this.drawLine(this.colAObject,this.colBObject,this.lineColor)):a=this.drawLine(this.colAObject,this.colBObject)),a===!0&&(this.removeReferences(this.colAObject.getID()),this.removeReferences(this.colBObject.getID()),$(this.colAObject.$el.children()[0]).addClass(this.objData.pairedStyle).removeClass(this.objData.selectedStyle),$(this.colBObject.$el.children()[0]).addClass(this.objData.pairedStyle).removeClass(this.objData.selectedStyle),this.lineColor=this.objData.lineColor,this.lineColor=this.child_dict[this.colAObject.getID()].options.answer!==this.child_dict[this.colBObject.getID()].options.answer?void 0===this.objData.incorrectlineColor?this.objData.lineColor:this.objData.incorrectlineColor:void 0===this.objData.correctlineColor?this.objData.lineColor:this.objData.correctlineColor,h=this.colAObject.getID()+"_##_"+this.colBObject.getID()+"_##_"+this.lineColor,this.answer_dict[this.colAObject.getID()]=h,this.answer_dict[this.colBObject.getID()]=h,this.colAObject=void 0,this.colBObject=void 0)},s.prototype.onUpdateComplete=function(){this.customEventDispatcher(this.CHILD_UPDATE_COMPLETE,this,this),this.newCanvas.attr("width",this.$el.outerWidth()).attr("height",this.$el.outerHeight())},s.prototype.showAnswer=function(){void 0!==this.objData.showAnswerColor&&(this.lineColor=this.objData.showAnswerColor);var t=this,e={};_.filter(this.child_dict,function(t,i){e[t.options.answer]=void 0===e[t.options.answer]?[]:e[t.options.answer],e[t.options.answer].push(i),void 0!==t.feedback&&t.feedback.hideFeedback()}),_.filter(e,function(e){t.prepareDataForLines(e[0],!0),t.prepareDataForLines(e[1],!0)}),this.sendStatementToLRS("showAnswer_",""),this.customEventDispatcher(this.SHOW_ANSWER,this,this)},s.prototype.removeLines=function(t,e){var i,s,o=!1;return void 0!==t&&void 0!==e&&(i=t.getID(),s=e.getID(),this.answer_dict[s]?(this.child_dict[s].options.flag="0",o=!0):this.answer_dict[i]&&(this.child_dict[i].options.flag="0",o=!0)),o},s.prototype.showIncorrectMatch=function(){var t,e,i,s,o=this;_.filter(this.answer_dict,function(a){var h=o.child_dict[a.split("_##_")[0]],n=o.child_dict[a.split("_##_")[1]];t=h.options.answer===n.options.answer,void 0!==h.feedback&&h.feedback.showFeedback(t),void 0!==n.feedback&&n.feedback.showFeedback(t);var c=a.split("_##_");i=h,s=n,e=c[2],o.drawLine(i,s,e)})},s.prototype.drawLine=function(t,e,i){var s,o,a,h,n,c,r,l,d,p,_=this;if(void 0!==t&&void 0!==e){for(h=t.$el.position().left/this.getStageScaleValue()+t.$el.outerWidth(),n=t.$el.position().top/this.getStageScaleValue()+t.$el.outerHeight()/2,"auto"!==t.$el.height()&&(n=t.$el.position().top/this.getStageScaleValue()+t.$el.height()/2),c=e.$el.position().left/this.getStageScaleValue(),r=e.$el.position().top/this.getStageScaleValue()+e.$el.outerHeight()/2,"auto"!==e.$el.height()&&(r=e.$el.position().top/this.getStageScaleValue()+e.$el.height()/2),h-=Number(this.objData.leftCoordinate),c+=Number(this.objData.rightCoordinate),n+=Number(this.objData.topCoordinate),r+=Number(this.objData.topCoordinate),l=$("canvas",this.$el),s=l.attr("id"),o=$("#"+s,this.$el)[0],a=o.getContext("2d"),a.beginPath(),$(this.arrCanvasLine).each(function(e,i){$(t.$el).attr("id")===i.targetA&&_.arrCanvasLine.splice(e,1)}),$(this.arrCanvasLine).each(function(t,i){$(e.$el).attr("id")===i.targetB&&_.arrCanvasLine.splice(t,1)}),d={moveToX:h,moveToY:n,lineToX:c,lineToY:r,customLineqColor:i,targetA:$(t.$el).attr("id"),targetB:$(e.$el).attr("id")},this.arrCanvasLine.push(d),a.clearRect(0,0,$(this.$el).width(),$(this.$el).height()),p=0;p<_.arrCanvasLine.length;p++)a.moveTo(_.arrCanvasLine[p].moveToX,_.arrCanvasLine[p].moveToY),a.lineTo(_.arrCanvasLine[p].lineToX,_.arrCanvasLine[p].lineToY),a.strokeStyle=void 0===_.arrCanvasLine[p].customLineqColor?this.objData.lineColor:_.arrCanvasLine[p].customLineqColor,a.lineWidth=this.objData.lineWidth,a.stroke(),a.closePath(),a.beginPath();return this.customEventDispatcher(this.PAIR_EVENT,this,this),!0}return!1},s.prototype.getObjectLength=function(t){var e,i=0;for(e in t)t.hasOwnProperty(e)&&i++;return i},s.prototype.checkAnswer=function(t){var e,i=this;return(t===!1||"false"===t)&&(e=this.getObjectLength(this.answer_dict)===this.getObjectLength(this.child_dict)),_.filter(this.answer_dict,function(t){e!==!1&&(e=i.child_dict[t.split("_##_")[0]].options.answer===i.child_dict[t.split("_##_")[1]].options.answer)}),null!==i.feedback&&i.feedback.showFeedback(e),this.showIncorrectMatch(),this.customEventDispatcher(this.CHECK_ANSWER,this,e),this.customEventDispatcher("onCheckAnswer",this,e),this.sendStatementToLRS("checkAnswer_",e===!0?"correct":"incorrect"),e},s.prototype.removeIncorrectLine=function(){var t,e={},i=this;_.filter(this.answer_dict,function(s,o){t=i.child_dict[s.split("_##_")[0]].options.answer===i.child_dict[s.split("_##_")[1]].options.answer,t===!1||(e[o]=i.answer_dict[o])}),this.answer_dict=e,this.setState(this.answer_dict)},s.prototype.showCorrectFeedback=function(){var t,e=this;_.filter(this.answer_dict,function(i){t=e.child_dict[i.split("_##_")[0]].options.answer===e.child_dict[i.split("_##_")[1]].options.answer,t===!1?(e.child_dict[i.split("_##_")[0]].hideFeedback(),e.child_dict[i.split("_##_")[1]].hideFeedback()):(e.feedback&&e.hideFeedback(),e.child_dict[i.split("_##_")[0]].showFeedback(!0),e.child_dict[i.split("_##_")[1]].showFeedback(!0))})},s.prototype.hideCorrectFeedback=function(){var t,e=this;_.filter(this.answer_dict,function(i){t=e.child_dict[i.split("_##_")[0]].options.answer===e.child_dict[i.split("_##_")[1]].options.answer,t===!1||(e.child_dict[i.split("_##_")[0]].hideFeedback(),e.child_dict[i.split("_##_")[1]].hideFeedback())})},s.prototype.showIncorrectFeedback=function(){var t,e=this;_.filter(this.answer_dict,function(i){t=e.child_dict[i.split("_##_")[0]].options.answer===e.child_dict[i.split("_##_")[1]].options.answer,t===!0?(e.child_dict[i.split("_##_")[0]].hideFeedback(),e.child_dict[i.split("_##_")[1]].hideFeedback()):(e.child_dict[i.split("_##_")[0]].showFeedback(!1),e.child_dict[i.split("_##_")[1]].showFeedback(!1),e.feedback&&e.feedback.hide())})},s.prototype.hideIncorrectFeedback=function(){var t,e=this;_.filter(this.answer_dict,function(i){t=e.child_dict[i.split("_##_")[0]].options.answer===e.child_dict[i.split("_##_")[1]].options.answer,t===!1&&(e.child_dict[i.split("_##_")[0]].hideFeedback(),e.child_dict[i.split("_##_")[1]].hideFeedback())})},s.prototype.getState=function(){var t=JSON.parse(JSON.stringify(this.answer_dict));return this.customEventDispatcher(this.GET_STATE_EVENT,this,t),_.filter(this.child_dict,function(e){e.feedback&&(t[e.feedback.strCompId]=e.feedback.getState())}),this.feedback&&(t[this.feedback.strCompId]=this.feedback.getState()),t},s.prototype.setState=function(t){var e,i,s,o=this;this.bEditor===!1&&(this.reset(),this.answer_dict=JSON.parse(JSON.stringify(t)),_.filter(this.answer_dict,function(t){if("object"!=typeof t){var a=t.split("_##_");e=o.child_dict[t.split("_##_")[0]],i=o.child_dict[t.split("_##_")[1]],s=a[2],o.drawLine(e,i,s)}}),_.filter(this.child_dict,function(e){e.feedback&&e.feedback.setState(t[e.feedback.strCompId])}),this.feedback&&this.feedback.setState(t[this.feedback.strCompId]),this.customEventDispatcher(this.SET_STATE_EVENT,this,this))},s.prototype.reset=function(){var t,e,i,s,o=this;e=$("canvas",this.$el),t=e.attr("id"),i=$("#"+t,this.$el)[0],s=i.getContext("2d"),s.clearRect(0,0,$(this.$el).width(),$(this.$el).height()),this.answer_dict={},this.arrCanvasLine=[],this.feedback&&this.feedback.hideFeedback(),_.filter(this.child_dict,function(t){$(t.$el.children()[0]).removeClass(o.objData.pairedStyle).removeClass(o.objData.selectedStyle),t.feedback&&t.feedback.hideFeedback()}),this.feedback&&this.feedback.hideFeedback(),this.customEventDispatcher(this.RESET_STATE_EVENT,this,this)},s.prototype.showFeedback=function(){this.checkAnswer(!0)},s.prototype.hideFeedback=function(){this.feedback&&this.feedback.hide()},s.prototype.disable=function(){this.$el.css("pointer-events","none"),this.customEventDispatcher(this.DISABLED_STATE,this,this)},s.prototype.enable=function(){this.$el.css("pointer-events",""),this.customEventDispatcher(this.ENABLED_STATE,this,this)},s.prototype.MatchingBoxSuper=i,s.prototype.destroy=function(){return this.answer_dict.length=0,this.child_dict.length=0,this.arrCanvasLine.length=0,this.lineColor=null,this.MatchingBoxSuper.prototype.destroy.call(this,!0)},s});