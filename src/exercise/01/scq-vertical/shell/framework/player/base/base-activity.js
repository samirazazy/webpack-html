define(["marionette","player/events/eventsconst","player/manager/popup-manager","player/constants/errorconst","player/controllers/tincan-controller","printArea","framework/libs/html2canvas"],function(t,i,e,o,n){var s;return s=Backbone.Marionette.Layout.extend({bEditor:!1,className:"defaultActivityStyle",ActivityEventConst:i,strActivityName:void 0,nActivityIndex:void 0,isBaseActivity:!0,isDestroyCalled:!1,nStageScale:1,localLangName:void 0,objEventController:void 0,groupName:void 0,modelName:void 0,localText:void 0,strName:void 0,allRegionData:void 0,allRegionActivityList:void 0,mComp:{},activityRegionId:void 0,objErrConst:o,PopupManager:void 0,toolbox:void 0,objInlineTmplDict:void 0,strRegionName:void 0,popupData:null,popupCounter:0,popupDiv_dict:{},broadcastEventDict:void 0}),s.prototype.preinitialize=function(){},s.prototype.postInitialize=function(){},s.prototype.onActivityCreationComplete=function(){},s.prototype.getRegionChangeNotification=function(){},s.prototype.onPlayerInitComplete=function(){},s.prototype.setData=function(t){this.objInlineTmplDict=t},s.prototype.setID=function(t){this.strActivityName=t},s.prototype.getID=function(){return this.strActivityName},s.prototype.initBaseActivity=function(){var t;this.broadcastEventDict={},this.broadcastEventReceiver(this.ActivityEventConst.MANAGE_COMMON_BROADCAST_EVENT,this,"manageCommonBroadcastEvent"),this.PopupManager=e,this.ActivityEventConst=i,t=window.AudioContext||window.webkitAudioContext,t&&(this.bWebApiEnable=!0)},s.prototype.getToolbox=function(){return this.toolbox},s.prototype.setState=function(){},s.prototype.resetActivity=function(){},s.prototype.endActivity=function(){this.trigger(this.ActivityEventConst.ACTIVITY_END_EVENT,this)},s.prototype.jumpToActivityByIndex=function(t){this.activityIndex=t,this.trigger(this.ActivityEventConst.JUMP_TO_ACTIVITY_BY_INDEX_EVENT,this)},s.prototype.jumpToActivityByID=function(t){this.activityID=t,this.trigger(this.ActivityEventConst.JUMP_TO_ACTIVITY_BY_ID_EVENT,this)},s.prototype.launchNextActivity=function(){this.trigger(this.ActivityEventConst.ACTIVITY_GO_TO_NEXT_ACTIVITY_EVENT,this)},s.prototype.userActionPerform=function(){this.trigger(this.ActivityEventConst.USER_ACTION,this)},s.prototype.launchPreviousActivity=function(){this.trigger(this.ActivityEventConst.ACTIVITY_GO_TO_PREVIOUS_ACTIVITY_EVENT,this)},s.prototype.setEventController=function(t){this.objEventController=t},s.prototype.showHideRegionById=function(t,i){var e={};e.task=this.ActivityEventConst.SHOW_HIDE_REGION,e.type=this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,e.regionToHIde=t,e.state=i,this.trigger(this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,e)},s.prototype.attachListener=function(t,i,e,o){this.objEventController.addEventListener(t,i,e,o)},s.prototype.detachListener=function(t,i,e){this.objEventController.removeEventListener(t,i,e)},s.prototype.getComponent=function(t,i,e,o){var n={};n.context=t,n.strCompType=i,n.strCallback=e,n.data=o,this.trigger(this.ActivityEventConst.CREATE_COMPONENT_EVENT,n)},s.prototype.getScreenText=function(t){var i,e;return i=$(this.localText).find("text[id="+t+"]"),e=$(i[0]).text()},s.prototype.customEventDispatcher=function(t,i,e){var o={};o.data=i,o.customData=e,o.target=i,o.type=t,i.trigger(t,o)},s.prototype.broadcastEvent=function(t,i){var e={};e.eventToBroadcast=t,e.data=i,this.trigger(this.ActivityEventConst.BROADCAST_EVENT,e)},s.prototype.broadcastEventReceiver=function(t,i,e){var o={};o.eventToListen=t,o.context=i,o.callback=e,this.trigger(this.ActivityEventConst.BROADCAST_EVENT_RECEIVER,o)},s.prototype.stopBroadcastEventReceiver=function(t,i,e){var o={};o.eventToListen=t,o.context=i,o.callback=e,this.trigger(this.ActivityEventConst.STOP_BROADCAST_EVENT_RECEIVER,o)},s.prototype.playAudio=function(t,i,e,o,n,s){var r={};r.strPath=t,r.bLoop=i,r.strTrack=e,r.reload=o,r.onStart=s,r.onFinish=n,this.trigger(this.ActivityEventConst.PLAY_AUDIO,r)},s.prototype.isWebApiEnable=function(){return this.bWebApiEnable},s.prototype.initWebApi=function(t){this.bWebApiEnable===!0&&this.trigger(this.ActivityEventConst.INIT_WEB_API_AUDIO,t)},s.prototype.playWebAudio=function(t){this.bWebApiEnable===!0&&this.trigger(this.ActivityEventConst.PLAY_WEB_API_AUDIO,t)},s.prototype.unloadBuffers=function(t){this.bWebApiEnable===!0&&this.trigger(this.ActivityEventConst.UNLOAD_WEB_API_BUFFERS_AUDIO,t)},s.prototype.stopAllAudio=function(t){var i={};i.bDestroy=t,this.trigger(this.ActivityEventConst.STOP_ALL_AUDIO,i)},s.prototype.restart=function(t){this.trigger(this.ActivityEventConst.RESTART_AUDIO,t)},s.prototype.pauseAudio=function(t){this.trigger(this.ActivityEventConst.PAUSE_AUDIO,t)},s.prototype.resumeAudio=function(t){this.trigger(this.ActivityEventConst.RESUME_AUDIO,t)},s.prototype.stopAudio=function(t,i){var e={};e.trackId=t,e.destroy=i,this.trigger(this.ActivityEventConst.STOP_AUDIO,e)},s.prototype.setVolume=function(t,i){this.trigger(this.ActivityEventConst.VOLUME_CHANGE,{strTrackID:t,volume:i})},s.prototype.setDefaultVolume=function(t){this.trigger(this.ActivityEventConst.DEFAULT_VOLUME_CHANGE,{volume:t})},s.prototype.showPreloader=function(t){var i={};i.message=t,i.task=this.ActivityEventConst.SHOW_PRELOADER,i.type=this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,this.trigger(this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,i)},s.prototype.hidePreloader=function(){var t={};t.task=this.ActivityEventConst.HIDE_PRELOADER,t.type=this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,this.trigger(this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,t)},s.prototype.updatePlayerSize=function(t){t.task=this.ActivityEventConst.UPDATE_PLAYER_SIZE_EVENT,t.type=this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,this.trigger(this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,t)},s.prototype.getStageScaleValue=function(){return this.nStageScale},s.prototype.getActivityListByRegion=function(t){return this.allRegionActivityList[t].slice()},s.prototype.launchActivityInRegion=function(t,i,e,o){o=void 0===o?!1:o;var n={};n.regionId=t,n.regionToChange=t,n.data=e,n.strActivityID=i,n.bLaunchByIndex=o,n.task=this.ActivityEventConst.LAUNCH_ACTIVITY_IN_REGION,n.type=this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,this.trigger(this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,n)},s.prototype.startRegion=function(t,i,e,o){o=void 0===o?!1:o;var n={};n.regionToStart=t,n.regionId="",n.data=i,n.strActivityID=e,n.bLaunchByIndex=o,n.task=this.ActivityEventConst.START_REGION_FROM_OTHER_REGION,n.type=this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,this.trigger(this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,n)},s.prototype.changeRegionActivities=function(t,i,e,o,n){var s={};s.regionId=t,s.strActList=i,s.immediateStart=e,s.defaultActId=o,s.data=n,s.task=this.ActivityEventConst.UPDATE_REGION_ACTIVITY_LIST,s.type=this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,this.trigger(this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,s)},s.prototype.getLanguageName=function(){return this.localLangName},s.prototype.removeJS=function(t){var i={};i.fileName=t+".js",i.type=this.ActivityEventConst.TYPE_JS,this.trigger(this.ActivityEventConst.REMVOE_REFERENCE,i)},s.prototype.removeCSS=function(t){var i={};i.fileName=t+".css",i.type=this.ActivityEventConst.TYPE_CSS,this.trigger(this.ActivityEventConst.REMVOE_REFERENCE,i)},s.prototype.setDrawingCanvas=function(t){this.trigger(this.ActivityEventConst.SET_DRAWING_CANVAS,t)},s.prototype.getInlineTemplateById=function(t){return this.objInlineTmplDict[t]},s.prototype.createRegion=function(t){var i={};i[t]="#"+t,void 0!==this.regions[t]?console.warn(t+o.ACTIVITY_ALREADY_REGISTERED):this.addRegions(i)},s.prototype.launchAsPopup=function(t,i,e,o,n,s){var r,p,a,v,c,E=this,A="#"+i,h=this.getInlineTemplateById("screenPopupBlockerDiv");void 0===this.popupDiv_dict[t]&&(r=$(this.getInlineTemplateById(t)).attr("class"),h=this.getInlineTemplateById("screenPopupBlockerDiv"),this.popupData={},e===!0&&(v=$(h),$("#"+i).append(v),this.popupData.blockerDiv=v),h=this.getInlineTemplateById(t),this.popupData.templateId=t,this.popupData.popupRef=$(h),this.popupData.targetArea=$("#"+i),this.popupData.popupParent=A,n?this.popupData.popupRef.hide().appendTo(this.popupData.targetArea).show().animate(n,parseInt(n.duration)):this.popupData.popupRef.hide().appendTo(this.popupData.targetArea).show(),E.onPopupAddedInDom(E.popupData),e===!0&&(this.popupCounter=this.popupCounter+1,v.attr("id",v.attr("id")+this.popupCounter),this.popupData.blockerDiv=v),void 0!==s&&void 0!==s.styleClass&&(v.removeClass(),v.addClass(s.styleClass)),this.popupData.popupRef.attr("tempId",this.popupData.templateId),this.popupData.objClassRef=this,this.popupDiv_dict[t]=this.popupData,void 0!==o&&(a=t+"___"+o,c="#"+o,p=$("#"+o,"#"+this.popupData.popupRef.attr("id")),p.attr("id",a),p.on("click",function(t){$(t.target).off("click"),E.removePopupWindow(t.target.id.split("___")[0])}),E.popupDiv_dict[t].strCloseId=a))},s.prototype.onPopupAddedInDom=function(){},s.prototype.onPopupClose=function(){},s.prototype.removeAllPopupWindow=function(){var t=this;_.filter(this.popupDiv_dict,function(i){t.removePopupWindow(i.templateId)})},s.prototype.closePopup=function(t){var i=t.data.objClassRef;i.removePopupWindow(t.data.templateId)},s.prototype.removePopupWindow=function(t){if(void 0!==t){var i,e=this;i=this.popupDiv_dict[t],void 0!==i&&null!==i&&(e.onPopupClose(i.templateId),void 0!==i.strCloseId&&$("#"+i.strCloseId,$(i.popupRef)).off("click"),i.popupRef.remove(),(null!==i.blockerDiv||void 0!==i.blockerDiv)&&($(i.blockerDiv).css("display","none"),$(i.blockerDiv).remove()),this.popupDiv_dict[t]=null,delete this.popupDiv_dict[t])}},s.prototype.manageCommonBroadcastEvent=function(t){if(this.strRegionName===t.data.region){var i;switch(t.type){case this.ActivityEventConst.MANAGE_COMMON_BROADCAST_EVENT:switch(t.data.subTask){case this.ActivityEventConst.CALL_AND_UPDATE_COMPONENT:i="self"===t.data.targetId?this:this[t.data.targetId],i[t.data.methodName].apply(this,t.data.params)}}}},s.prototype.stopAllRegion=function(t,i,e){var o={};o.task=this.ActivityEventConst.STOP_ALL_REGIONS,o.type=this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,o.state=t,o.ignoreCaller=i,o.activitiesData=e,this.trigger(this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,o)},s.prototype.startRegion=function(t,i,e){var o={};o.task=this.ActivityEventConst.START_STOP_REGION,o.regionToStart=t,o.type=this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,o.state=i,o.activitiesData=e,this.trigger(this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,o)},s.prototype.hideAllRegions=function(t){var i={};i.task=this.ActivityEventConst.HIDE_ALL_REGION,i.type=this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,i.state=t,this.trigger(this.ActivityEventConst.PLAYER_COMMON_TASK_EVENT,i)},s.prototype.playerBubbleEvent=function(t){var i={};i.task=t.task,i.type=this.ActivityEventConst.PLAYER_BUBBLE_EVENT,i.customData=t,this.trigger(this.ActivityEventConst.PLAYER_BUBBLE_EVENT,i)},s.prototype.handlePlayerCommonBubbleEvent=function(){},s.prototype.performTinCanOperation=function(t){n.getInstance().tincanOperation(t)},s.prototype.print=function(t,i,e){t=void 0!==t?t:"screenHolder",e=e instanceof Object?e:{},i===!0||"true"===i?this.printCanvas(t,e):$("#"+t,this.$el).printArea(e)},s.prototype.printCanvas=function(t,i){var e,o=this,n=$("#"+t,o.$el),s=n.find("video"),r={};html2canvas(n[0],{onrendered:function(t){r=n.offset(),_.filter(s,function(i){var e,n,s,p,a,v,c,E=$(i),A={};s=E[0].videoWidth,p=E[0].videoHeight,c=o.greatestCommonDiv(s,p),A.w=s/c,A.h=p/c,a=E.height()/A.h*A.w,v=E.height(),e=E.offset().left-r.left+(E.width()-a)/2,n=E.offset().top-r.top+(E.height()-v)/2,t.getContext("2d").drawImage(E[0],e,n,a,v)}),$("#printFrame").remove(),e=$('<iframe id="printFrame" style="height: 1px; border: 0px none; position: absolute; top: 0px; left: 0px;"></iframe>'),e.appendTo($("body")),$('<div id="printDiv" style="overflow: hidden;"><img src='+t.toDataURL()+"></img></div>").appendTo($("#printFrame")),setTimeout(function(){$("#printFrame").printArea(i)},0)}})},s.prototype.greatestCommonDiv=function(t,i){return 0==i?t:this.greatestCommonDiv(i,t%i)},s.prototype.destroy=function(t){if(this.removeAllPopupWindow(),t!==!0)throw new Error(o.DESTROY_NOT_IMPLMENENTED_IN_CHILD_CLASS);return this.isDestroyCalled=!0,this.isDestroyCalled},s});