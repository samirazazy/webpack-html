define(["marionette","player/controllers/comptree-controller","player/controllers/config-updater","player/events/eventsconst"],function(t,e,o,a){var i;return i=Backbone.Marionette.Controller.extend({objPropertyControllerDict:{},objMPlayer:void 0,objCompTreeController:void 0,strActiveRegionName:void 0,playerRegionData:void 0,arrRegions:void 0,objConfigUpdater:void 0,configInXmlFormat:void 0,strConfigPath:void 0,bDataModied:!1,userLastAction:void 0,objPathUpdater:void 0,objSelectedRef:void 0,objMemoryObject:void 0,filterSelected:void 0,start:function(t,a,i){this.strConfigPath=i,this.configInXmlFormat=a,this.playerRegionData=t,this.arrRegions=[],void 0===this.playerRegionData.region.length?this.arrRegions.push(this.playerRegionData.region):this.arrRegions=this.playerRegionData.region,this.objPropertyControllerDict={},this.objCompTreeController=e.getInstance(),this.objConfigUpdater=new o(this.configInXmlFormat),this.objConfigUpdater.on(this.objConfigUpdater.REGION_DATA_CHANGE_EVENT,this.onRegionDataModified,this),this.objCompTreeController.off(this.objCompTreeController.TREE_NODE_SELECTED).on(this.objCompTreeController.TREE_NODE_SELECTED,this.selectComponent,this)}}),i.prototype.setPathUpdater=function(t){this.objPathUpdater=t},i.PROPERTY_MANAGER_UPDATE_EVENT="propertyManagerUpdateEvent",i.EDITOR_DATA_UPDATE_EVENT="editorDataUpdateEvent",i.prototype.onRegionCreatedInEditMode=function(t){var e=new PropertyController;e.initController(),e.on(PropertyController.REGION_VIEW_UPDATE_COMPLETE_EVENT,this.onRegionViewUpdateCompleteEvent,this),e.on(PropertyController.SIM_PICTOR_READY_TO_USE,this.onSimPictorReadyToUse,this),e.on(a.DATA_COPIED_IN_MEMORY,this.handleOtherControllerCommands,this),e.setPathResolver(this.objPathUpdater),e.start(t),this.objPropertyControllerDict[t]=e},i.prototype.onRegionViewUpdateCompleteEvent=function(t){var e;void 0!==this.filterSelected?(e=this.objPropertyControllerDict[this.strActiveRegionName].filterComponentListAndData(this.filterSelected),this.objCompTreeController.filterData(e,this.filterSelected)):this.objCompTreeController.setData(t.componentList,t.json)},i.prototype.handleOtherControllerCommands=function(t){this.objMemoryObject=t.compData},i.prototype.updateComponentTreeView=function(){var t;void 0!==this.filterSelected?(t=this.objPropertyControllerDict[this.strActiveRegionName].filterComponentListAndData(this.filterSelected),this.objCompTreeController.filterData(objData,this.filterSelected)):(t=this.objPropertyControllerDict[this.strActiveRegionName].getCompTreeData(),this.objCompTreeController.setData(t.componentList,t.json))},i.prototype.onSimPictorCreated=function(t){this.objPropertyControllerDict[t.regionId].onActivityInitInEditMode(t.simPictor),this.bDataModied=!1},i.prototype.onSimPictorReadyToUse=function(){this.updateForCurrentActity()},i.prototype.handleRegionManagerEvents=function(t){var e,o,a,i={};if(t.regionToUpdate!==this.strActiveRegionName){for(e=0;e<this.arrRegions.length;e+=1)if(this.arrRegions[e].id===t.regionToUpdate){o=this.arrRegions[e];break}this.strActiveRegionName=t.regionToUpdate,a=this.objPropertyControllerDict[t.regionId].getRootPath().dataPath,a=a.slice(0,a.lastIndexOf("/")),i.rootPath=a,i.jsonFilePath=this.objPropertyControllerDict[t.regionId].getRootPath().dataPath,i.stylePath=this.objPropertyControllerDict[t.regionId].getRootPath().stylePath,i.helperPath=this.objPropertyControllerDict[t.regionId].getHelperFilePath(),i.regionId=this.strActiveRegionName,i.regionData=o,i.dloRootPath=this.objPathUpdater.dloRootPath(),i.themes=this.objConfigUpdater.getThemes(),i.langs=this.objConfigUpdater.getLanguages(),this.dispatchEvents("regionChange",i),this.updateComponentTreeView()}this.executeTask(t)},i.prototype.executeTask=function(t){var e=t.task,o={};switch(e){case"componentSelected":o=this.objPropertyControllerDict[t.regionId].getChildComponentListAndData(t.compData.customData),o.objPropertyControllerDict=this.objPropertyControllerDict,o.activeRegion=t.regionId,o.compId=t.compData.customData,o.regionToUpdate=t.regionToUpdate,this.dispatchEvents("onComponentListUpdated",o),this.objCompTreeController.selectTreeNode(t.compData.customData)}this.objPropertyControllerDict[t.regionId].handleManagerCommand(t)},i.prototype.updateForCurrentActity=function(){var t,e,o={};void 0!==this.objPropertyControllerDict[this.strActiveRegionName]&&(e=this.objPropertyControllerDict[this.strActiveRegionName].getRootPath(),t=e.dataPath,t=t.slice(0,t.lastIndexOf("/")),o.rootPath=t,o.jsonFilePath=e.dataPath,o.stylePath=e.stylePath,o.regionId=this.strActiveRegionName,o.dloRootPath=this.objPathUpdater.dloRootPath(),o.helperPath=this.objPropertyControllerDict[this.strActiveRegionName].getHelperFilePath(),o.themes=this.objConfigUpdater.getThemes(),o.langs=this.objConfigUpdater.getLanguages(),this.dispatchEvents("changeActivity",o),this.updateComponentTreeView())},i.prototype.handleCompUpdateEvents=function(t){var e;switch(t.data&&t.data.data&&(e=t.data.data.task.split("_")[2]),this.bDataModied!==!0&&(this.bDataModied=!0,this.dispatchEvents("dataModifedByUser",this.bDataModied)),e){case a.EDIT_DOM_LAYOUT_PASTE:this.objPropertyControllerDict[t.data.regionToUpdate].setMemoryData(this.objMemoryObject)}this.objPropertyControllerDict[t.data.regionToUpdate].onComponentPropertyUpdate(t.data)},i.prototype.manageAllEditorEvents=function(t){var e,o,a,i,r=this,n=t.data.task;switch(o=t.data.compData,n){case"save":this.userLastAction=t.data.compData,this.prepareDataForSave();break;case"saveAsTemplate":this.userLastAction=t.data.compData.userNextAction,this.prepareDataForSaveAsTemplate(t.data.compData);break;case"sourceViewerSave":this.userLastAction=t.data.compData.userLastAction,e=t.data.compData.data,a=t.data.compData.path,i=t.data.compData.type,this.prepareDataForSaveSourceViewer(e,a,i);break;case"reloadPropertyUpdatorCssData":a=t.data.compData,this.objPropertyControllerDict[this.strActiveRegionName].collectStyles(a);break;case"reloadPropertyUpdatorJsonData":a=t.data.compData;break;case"getRegionList":e={},e.arrRegionIds=$.map(this.arrRegions,function(t){return t.id}),this.dispatchEvents("regionList",e);break;case"selecteRegion":e={},e.regionToUpdate=t.data.compData,e.regionId=t.data.compData,setTimeout(function(){r.handleRegionManagerEvents(e)},1e3);break;case"modifyConfig":this.objConfigUpdater.modify({regionId:o.activeRegion,data:o.data,action:o.action});break;case"getConfigSettingsData":e={},e.sizeData=this.objConfigUpdater.getAspectRatio(),e.languageData=this.objConfigUpdater.getLanguages(),e.scaleData=this.objConfigUpdater.getScale(),e.themeData=this.objConfigUpdater.getThemes(),this.dispatchEvents("configSettingData",e);break;case"setConfigSettingsData":e=t.data.compData,this.objConfigUpdater.addTheme(e.theme,"theme","data/themes/theme"+e.theme+"/theme"+e.theme+".css",!0,!0,e.theme),this.objConfigUpdater.setAspectRatio(e.width,e.height),this.objConfigUpdater.setScale(e.bScale,e.minScale,e.maxScale),this.objConfigUpdater.setLanguageSupport(e.bLanguage,"data/local",e.defLang),e={},e.data=[],e.data.push({FilePath:this.strConfigPath,FileData:this.objConfigUpdater.getConfigString()}),this.dispatchEvents("saveUpdatedFile",e);break;case"dataSavedSuccessfully":this.dispatchEvents("dataSaved",this.userLastAction);break;case"templateCreated":case"saveAsTemplateFail":this.dispatchEvents(n,n);break;case"renameDlo":e=t.data.compData,this.dispatchEvents("renameDlo",e);break;case"onRenameDloSuccess":this.dispatchEvents("renameDloSuccess",e);break;case"getScriptReference":this.getScriptFileReference();break;case"filterComponentList":this.filterSelected=o.filter,void 0===this.filterSelected?this.updateComponentTreeView():(e=this.objPropertyControllerDict[this.strActiveRegionName].filterComponentListAndData(o.filter),this.objCompTreeController.filterData(e,o.filter));break;case"PLAYER_IN_STRICT_MODE":this.setEditingMode(t)}},i.prototype.setEditingMode=function(t){var e,o,a=this;o="true"===t.data.compData?!0:t.data.compData,$.each(a.objPropertyControllerDict,function(t){e=a.objPropertyControllerDict[t],e.setEditingMode(o)})},i.prototype.getScriptFileReference=function(){var t,e=this,o={};$.each(e.objPropertyControllerDict,function(a){var i={};t=e.objPropertyControllerDict[a].getRootPath().dataPath,t=t.slice(0,t.lastIndexOf("/")),i.rootPath=t,i.helperPath=e.objPropertyControllerDict[a].getHelperFilePath(),i.regionId=a,o[a]=i}),o.dloRootPath=this.objPathUpdater.dloRootPath(),this.dispatchEvents("onAllRegionSciptFileData",o)},i.prototype.onRegionDataModified=function(t){var e={},o={};e.regionId=this.strActiveRegionName,e.regionData=t,this.dispatchEvents("regionNodeChange",e,!0),o.data=[],o.data.push({FilePath:this.strConfigPath,FileData:this.objConfigUpdater.getConfigString()}),this.dispatchEvents("saveUpdatedFile",o)},i.prototype.editorPlayerInitComplete=function(){this.objConfigUpdater.getConfigString(),this.dispatchEvents("editorReadyEvent")},i.prototype.prepareDataForSaveAsTemplate=function(t){var e,o,a;e=this.objPropertyControllerDict[this.strActiveRegionName].getActivityDataToSave(),o=e.dloData[0].filePath.split("/"),o.pop(),a=o.join("/"),t.TemplatePath=a,this.dispatchEvents("dataReadyForSaveAsTemplate",t)},i.prototype.prepareDataForSave=function(){var t,e=[];for(t in this.objPropertyControllerDict)this.objPropertyControllerDict.hasOwnProperty(t)&&e.push(this.objPropertyControllerDict[t].getActivityDataToSave());this.bDataModied=!1,this.dispatchEvents("dataReadyToSave",e),this.dispatchEvents("dataModifedByUser",this.bDataModied)},i.prototype.prepareDataForSaveSourceViewer=function(t,e){var o={};o={},o.data=[],o.data.push({FileData:t,FilePath:e}),this.bDataModied=!1,this.dispatchEvents("saveUpdatedFile",o)},i.prototype.dispatchEvents=function(t,e,o){var a={};a.eventName=t,a.data=e,a.type=i.PROPERTY_MANAGER_UPDATE_EVENT,o===!0&&(a.type=i.EDITOR_DATA_UPDATE_EVENT),this.trigger(i.PROPERTY_MANAGER_UPDATE_EVENT,a)},i.prototype.deselectComponent=function(){void 0!==this.objSelectedRef&&(this.objSelectedRef.isSelected(!1),this.objSelectedRef=void 0)},i.prototype.selectComponent=function(t,e){var o=this.objPropertyControllerDict[this.strActiveRegionName].getSelectorRef(t);this.objSelectedRef!==o&&(this.deselectComponent(),o.isSelected(!0,e),this.objPropertyControllerDict[this.strActiveRegionName].populatePropertyPanelData("componentSelected",t),this.objSelectedRef=o)},i.prototype.destroy=function(){var t=this;return console.log("destroy --------------------------------"),t.strActiveRegionName=void 0,$.each(t.objPropertyControllerDict,function(e){t.objPropertyControllerDict[e].off(PropertyController.REGION_VIEW_UPDATE_COMPLETE_EVENT),t.objPropertyControllerDict[e].off(PropertyController.SIM_PICTOR_READY_TO_USE),t.objPropertyControllerDict[e].off(PropertyController.DATA_COPIED_IN_MEMORY),delete t.objPropertyControllerDict[e]}),t.objPropertyControllerDict=null,!0},i});