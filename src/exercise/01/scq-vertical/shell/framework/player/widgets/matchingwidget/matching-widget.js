!function(t){t.widget("custom.MatchingWidget",{options:{correctMapping:[],shuffle:!1,linkType:"line",previousSource:null,isOneToOne:!0},_init:function(){},_create:function(){this.attachListeners()},attachListeners:function(){var e;e="[type=target]",t(this.element).find(e).unbind("click").bind("click",this,this.onItemClicked),e="[type=source]",t(this.element).find(e).unbind("click").bind("click",this,this.onItemClicked)},removeListeners:function(){var e;e="[type=target]",t(this.element).find(e).unbind("click",this,this.onItemClicked),e="[type=source]",t(this.element).find(e).unbind("click",this,this.onItemClicked)},onItemClicked:function(e){var r,i;i=e.data,r=t(e.currentTarget).attr("type"),"source"===r?i.saveSourceRefernece(i,e.currentTarget):(i.isTargetOccupied(e.currentTarget)&&i.removeLink(e.currentTarget),i.isSourceSelected()&&(i.options.isOneToOne&&i.removeLink(i.options.previousSource),i.addDataToSourceAndTarget(i.options.previousSource,e.currentTarget),i.drawLink(i.options.previousSource,e.currentTarget)),i.removeActiveState(i.options.previousSource))},addDataToSourceAndTarget:function(e,r){var i,n,o;t(r).attr("source",t(e).attr("id")),n=t(r).attr("id"),this.options.OneToOne?t(e).attr("target",n):(i=t(e).attr("target"),i?(i=i+"|"+n,o=i.split("|"),o.sort(),i=o.join("|")):i=n,t(e).attr("target",i))},saveSourceRefernece:function(e,r){e.removeActiveState(e.options.previousSource),e.options.previousSource=t(r),e.applyActiveState(t(r))},isTargetOccupied:function(e){return t(e).attr("source")?!0:!1},isSourceSelected:function(){return t(this.options.previousSource).hasClass("activeState")?!0:!1},applyActiveState:function(t){t.addClass("activeState")},removeActiveState:function(t){t&&t.removeClass("activeState")},drawLink:function(e,r){var i,n,o,s,a,c,u,l,p,d;i=parseInt(t(e).css("left"),10),n=parseInt(t(e).css("top"),10),o=i+t(e).outerWidth(),s=n+t(e).outerHeight()/2,a=parseInt(t(r).css("left"),10),c=parseInt(t(r).css("top"),10),u=a,l=c+t(r).outerHeight()/2,p=t(e).attr("id")+"_"+t(r).attr("id"),d=document.createElementNS("http://www.w3.org/2000/svg","line"),d.setAttribute("id",p),d.setAttribute("x1",o),d.setAttribute("y1",s),d.setAttribute("x2",u),d.setAttribute("y2",l),t("#svgelem").append(d)},removeLink:function(e){var r,i,n,o,s,a,c;r=t(e).attr("type"),"target"===r?(i=t(e).attr("source"),o=i+"_"+t(e).attr("id"),t("#"+o).remove(),t(e).attr("source",null),this.options.isOneToOne?t("#"+i).attr("target",null):(s=t("#"+i).attr("target"),a=s.split("|"),c=a.indexOf(t(e).attr("id")),a.splice(c,1),a.sort(),s=a.join("|"),t("#"+i).attr("target",s))):(n=t(e).attr("target"),o=t(e).attr("id")+"_"+n,t("#"+o).remove(),t("#"+n).attr("source",null),t(e).attr("target",null))},evaluate:function(){var t,e,r,i,n,o;for(t=this.options.correctMapping,e=t.length,r=this.getLinkedObjectsMap(),i=0,n=0;e>n;n++)t.indexOf(r[n])>-1&&i++;return o={},o.correctAnswer=i,o.totalQuestion=r.length,o},reveal:function(){var e,r,i,n,o,s,a,c,u,l;for(e=this.options.correctMapping,r=e.length,t("#svgelem").empty(),i=0;r>i;i++){if(o=e[i],s=o.split(":")[0],a=o.split(":")[1],c=t("#"+s),a.indexOf("|")>-1)for(l=a.split("|"),n=0;n<l.length;n++)this.drawLink(c,t("#"+l[n]));else u=t("#"+a),this.drawLink(c,u);this.removeActiveState(c)}},reset:function(){var e,r,i,n,o,s,a,c,u;for(e=this.options.correctMapping,r=e.length,t("#svgelem").empty(),i=0;r>i;i++){if(o=e[i],s=o.split(":")[0],c=t("#"+s).attr("target",null),a=o.split(":")[1],a.indexOf("|")>-1)for(u=a.split("|"),n=0;n<u.length;n++)t("#"+u[n]).attr("source",null);else t("#"+a).attr("source",null);this.removeActiveState(c)}},getLinkedObjectsMap:function(){var e,r,i,n,o,s;for(e=t(this.element).find("[type=source]"),r=e.length,o=[],n=0;r>n;n++)i=e[n],s=t(i).attr("id")+":",t(i).attr("target")&&(s+=t(i).attr("target")),o.push(s);return o},_destroy:function(){this.removeListeners()}})}(jQuery);