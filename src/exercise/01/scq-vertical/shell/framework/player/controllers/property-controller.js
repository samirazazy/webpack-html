define(["marionette","player/events/eventsconst","player/constants/errorconst","player/constants/playerconst","player/controllers/property-updater","player/utils/data-loader"],function(t,o,e,a,i,r){var n;return n=Backbone.Marionette.Controller.extend({objPropertyUpdater:null,strRegionName:null,objSimPictorRef:null,selectedComponentId:null,metaDataPath:void 0,pathResolver:void 0}),n.prototype.initController=function(){this.objPropertyUpdater=new i,this.registerEvents()},n.prototype.start=function(t){this.strRegionName=t},n.prototype.initMetadata=function(){this.metaDataPath=this.getRootPath().dataPath.split("blank-screen.json")[0]+"metadata.xml";var t=this.pathResolver.dloRootPath()+this.metaDataPath;this.loadData(t,"xml","application/xml","xml")},n.prototype.loadData=function(t,o,e,a){var i=this;this.dataLoader=new r,this.dataLoader.on(this.dataLoader.DATA_LOAD_SUCCESS,i.handleXmlLoadComplete),this.dataLoader.on(this.dataLoader.DATA_LOAD_FAILED,i.handleDataLoadFailed),this.dataLoader.load({url:t,dataType:o,contentType:e,returnType:a,scope:i})},n.prototype.handleXmlLoadComplete=function(t,o){o.objPropertyUpdater.updateMetadata(t),o.dataLoader.off(o.dataLoader.DATA_LOAD_SUCCESS),o.dataLoader.off(o.dataLoader.DATA_LOAD_FAILED)},n.prototype.handleDataLoadFailed=function(t,o){var e="<metadata></metadata>";o.objPropertyUpdater.updateMetadata($.parseXML(e)),o.dataLoader.off(o.dataLoader.DATA_LOAD_SUCCESS),o.dataLoader.off(o.dataLoader.DATA_LOAD_FAILED)},n.prototype.getRootPath=function(){return this.objSimPictorRef?this.objSimPictorRef.objActRef.activityData:""},n.prototype.onActivityInitInEditMode=function(t){this.objSimPictorRef&&(this.objSimPictorRef.off(o.SIM_PICTOR_INIT_COMPLETE_EVENT),this.objSimPictorRef.off("component_removed_from_dom"),this.objSimPictorRef.off("comp_created_in_editor_mode"),this.objSimPictorRef.off("editDomLayoutUpdated")),this.objSimPictorRef=t,this.objSimPictorRef.on(o.SIM_PICTOR_INIT_COMPLETE_EVENT,this.onSimPictorReadyEvent,this),this.objSimPictorRef.on("component_removed_from_dom",this.handleSimpictorCommonEvent,this),this.objSimPictorRef.on("comp_created_in_editor_mode",this.handleSimpictorCommonEvent,this),this.objSimPictorRef.on("editDomLayoutUpdated",this.handleSimpictorCommonEvent,this)},n.prototype.onSimPictorReadyEvent=function(){var t={};t.jsonData=this.objSimPictorRef.strJSONData,this.objPropertyUpdater.start(t),this.objPropertyUpdater.collectStyles(this.objSimPictorRef.objActRef.activityData.stylePath),this.trigger(n.SIM_PICTOR_READY_TO_USE,t),this.initMetadata()},n.prototype.handleManagerCommand=function(t){switch(t.type){case o.PLAYER_EDIT_COMPONENT_EVENT:this.handleComponentEditEvents(t)}},n.prototype.handleComponentEditEvents=function(t){var e,a=t.task;switch(e=t.compData.customData,a){case"componentDataPropertyUpdatedFromSelector":break;case o.COMPONENT_SELECTED:this.selectedComponentId=e,this.populatePropertyPanelData(a,e)}},n.prototype.populatePropertyPanelData=function(t,o){var e={};e.jsonData=this.objSimPictorRef.objAssembler.getComponentDataById(o),e.jsonData.cssData=this.getComponentCssData(e.jsonData),e.metaData=this.objPropertyUpdater.getMetaDataById(o),this.broadcastEvent(t,e)},n.prototype.broadcastEvent=function(t,e){var a={},i={};a.task=t,a.type=o.PLAYER_EDIT_COMPONENT_EVENT,a.compData=e,a.regionToUpdate=this.strRegionName,"componentSelected"===a.task?(a.compType=a.compData.jsonData.type,this.objSimPictorRef.objActRef.broadcastEvent(o.COMPONENT_SELECTED,a)):"componentDeselected"===a.task&&(i.task=t,this.selectedComponentId=null,i.compType=a.compData.data.componentType,this.objSimPictorRef.objActRef.broadcastEvent(o.COMPONENT_SELECTED,i))},n.prototype.filterComponentListAndData=function(t){switch(t){case"ByAlphabet":return this.objSimPictorRef.objAssembler.filterComponentListAndData(t,this.objSimPictorRef.objAssembler.getChildComponentListAndData());case"ByType":return this.objSimPictorRef.objAssembler.filterComponentListAndData(t,this.objSimPictorRef.objAssembler.getChildComponentListAndData())}},n.prototype.getChildComponentListAndData=function(t){var o={};return o.compList=this.objSimPictorRef.objAssembler.getChildComponentListAndData(),t&&(o.jsonData=this.objPropertyUpdater.getComponentJSONDataById(t),o.metaData=this.objPropertyUpdater.getMetaDataById(t)),o},n.prototype.getComponentCssData=function(t){var o=this,e={};return t.data.stylelist&&$.each(t.data.stylelist,function(t,a){e[t]=o.objPropertyUpdater.getStyleClass(a)}),e.normal||(e.normal=this.objPropertyUpdater.getStyleClass(t.data.styleClass)),e},n.prototype.onComponentCreationCompleteInEditMode=function(t){var o={};o.jsonData=t.data,this.objPropertyUpdater.onComponentCreationCompleteInEditMode()},n.prototype.handleSimpictorCommonEvent=function(t){switch(t.type){case"component_removed_from_dom":this.onComponentRemoveFromDOM(t),this.onRegionCompUpdateComplete();break;case"comp_created_in_editor_mode":this.onComponentCreationCompleteInEditMode(t);break;case"editDomLayoutUpdated":this.onRegionCompUpdateComplete(),this.onDomLayoutUpdated(t)}},n.prototype.onComponentRemoveFromDOM=function(t){this.selectedComponentId=void 0,this.objPropertyUpdater.removeStyles(t.data.styleClasses)},n.prototype.onDomLayoutUpdated=function(t){this.objPropertyUpdater.updateJsonNodePosition(t)},n.prototype.registerEvents=function(){this.objPropertyUpdater.on(i.DATA_COPIED_IN_MEMORY,this.onDataCopiedInMemory,this),this.objPropertyUpdater.on(i.COMP_PROPERTY_UPDATED,this.onPropertyDataUpdated,this),this.objPropertyUpdater.on(i.CREATE_NEW_COMPONENT,this.handleNewCompCreation,this),this.objPropertyUpdater.on(i.REMOVE_SELECTED_COMPONENT,this.removeSelectedComponent,this),this.objPropertyUpdater.on(i.DOM_LAYOUT_UPDATE_EVENT,this.domLayoutUpdateEvent,this),this.objPropertyUpdater.on(i.DOM_CHANGE_VIEW_EVENT,this.handleChangeViewEvents,this),this.objPropertyUpdater.on(i.DESELECT_COMPONENT,this.propertyUpdaterCommonEvent,this),this.objPropertyUpdater.on(i.SELECT_COMPONENT,this.propertyUpdaterCommonEvent,this),this.objPropertyUpdater.on(i.INVALID_COMPONENT_CREATION,this.invalidComponentCreation,this)},n.prototype.removeEvents=function(){this.objPropertyUpdater.off(i.DATA_COPIED_IN_MEMORY),this.objPropertyUpdater.off(i.COMP_PROPERTY_UPDATED),this.objPropertyUpdater.off(i.CREATE_NEW_COMPONENT),this.objPropertyUpdater.off(i.REMOVE_SELECTED_COMPONENT),this.objPropertyUpdater.off(i.DOM_LAYOUT_UPDATE_EVENT),this.objPropertyUpdater.off(i.DOM_CHANGE_VIEW_EVENT),this.objPropertyUpdater.off(i.DESELECT_COMPONENT),this.objPropertyUpdater.off(i.SELECT_COMPONENT),this.objPropertyUpdater.off(i.INVALID_COMPONENT_CREATION)},n.prototype.flush=function(){this.removeEvents()},n.prototype.onDataCopiedInMemory=function(t){this.trigger(t.type,t)},n.prototype.setMemoryData=function(t){this.objPropertyUpdater.setMemoryData(t)},n.prototype.onPropertyDataUpdated=function(t){this.objSimPictorRef.objActRef.isScreeenEdited=!0,this.objSimPictorRef.objAssembler.editComponent(t),t.compData&&"name"===t.compData.actionKeys[2]?this.objSimPictorRef.selectComponent(t.compData.compId,!1):t.compData&&"stylelist"===t.compData.actionKeys[3]&&this.objSimPictorRef.selectComponent(t.compData.compId)},n.REGION_VIEW_UPDATE_COMPLETE_EVENT="regionViewUpdateCompleteEvent",n.SIM_PICTOR_READY_TO_USE="simPictorReadyToUseEvent",n.prototype.onRegionCompUpdateComplete=function(){var t={};t.regionName=this.strRegionName,t.componentList=this.objSimPictorRef.objAssembler.getChildComponentListAndData(),t.json=this.objSimPictorRef.objData.jsonData,this.trigger(n.REGION_VIEW_UPDATE_COMPLETE_EVENT,t)},n.prototype.getSelectorRef=function(t){return this.objSimPictorRef.objAssembler.getSelectorRef(t)},n.prototype.getCompTreeData=function(){var t={};return t.json=this.objSimPictorRef.objData.jsonData,t.componentList=this.objSimPictorRef.objAssembler.getChildComponentListAndData(),t},n.prototype.handleNewCompCreation=function(t){this.objSimPictorRef.objAssembler.createComponent(t.compData)},n.prototype.removeSelectedComponent=function(t){this.objSimPictorRef.removeSelectedComponent(t)},n.prototype.domLayoutUpdateEvent=function(t){this.objSimPictorRef.domLayoutUpdateEvent(t)},n.prototype.propertyUpdaterCommonEvent=function(t){var o=t.type;switch(o){case this.PropertyUpdater.DESELECT_COMPONENT:this.objSimPictorRef.objActRef.deselectComponent()}},n.prototype.handleChangeViewEvents=function(t){this.objSimPictorRef.objActRef.changeWizardView(t.compData)},n.prototype.invalidComponentCreation=function(t){this.objSimPictorRef.invalidComponentCreation(t)},n.prototype.onComponentPropertyUpdate=function(t){var o,e,a=t.compId;a=void 0===a?this.selectedComponentId:a,o=this.objSimPictorRef.objAssembler.getComponentDataById(a),e=void 0!==t.compData?t.compData:t,this.objPropertyUpdater.updateComponentData(o,e,this.objSimPictorRef.objAssembler.getCompRefById(a),t)},n.prototype.getActivityDataToSave=function(){var t={},o=[],e={};return o[0]={},o[0].filePath=this.objSimPictorRef.objActRef.activityData.dataPath,o[0].fileData=this.objPropertyUpdater.getScreenJSONData(),o[1]={},o[1].filePath=this.objSimPictorRef.objActRef.activityData.stylePath,o[1].fileData=this.objPropertyUpdater.getCssText(),o[2]={},o[2].filePath=this.metaDataPath,o[2].fileData=this.objPropertyUpdater.getMetadataXml(),e.dloData=o,e.assetsList=this.objPropertyUpdater.getAssetsToSaveList().concat(this.objPropertyUpdater.getJSONMediaList()),e.regionName=this.strRegionName,t.assetsList=this.objPropertyUpdater.getAssetsToSaveList().concat(this.objPropertyUpdater.getJSONMediaList()),t.regionName=this.strRegionName,e},n.prototype.setPathResolver=function(t){this.pathResolver=t},n.prototype.setEditingMode=function(t){this.objSimPictorRef.objAssembler.setEditingMode(t)},n.prototype.getHelperFilePath=function(){return this.objPropertyUpdater.getHelperFilePath()},n.prototype.collectStyles=function(t){this.objPropertyUpdater.collectStyles(t)},n.prototype.destroy=function(){return this.flush(),this.objPropertyUpdater.destroy(),!0},n});